# Automated provisioning of a high-availability MicroK8s cluster with MicroCeph storage.

## Overview
AutoK8s is a set of infrastructure-as-code tools that automate the deployment of a three-node Kubernetes cluster using MicroK8s and MicroCeph. The setup leverages OpenTofu/Terraform for VM provisioning on Proxmox and Ansible for configuration management, all orchestrated via SemaphoreUI.

## Architecture
The deployment creates a highly available, production-ready Kubernetes cluster:

- 3 MicroK8s nodes distributed across separate Proxmox hosts
- Direct disk passthrough and USB-attached storage for high-performance persistent storage
- MicroCeph integration for resilient, replicated storage
- Complete automation from VM creation to ready-to-use cluster

### Components
- MicroK8s: Lightweight, pure-upstream Kubernetes
- MicroCeph: Distributed storage system that integrates with MicroK8s
- OpenTofu/Terraform: Infrastructure provisioning
- Ansible: Configuration management
- SemaphoreUI: Workflow orchestration

### Prerequisites
- Proxmox VE cluster with at least 3 nodes
- API access to Proxmox with token-based authentication
- Ubuntu cloud image template (VMID: 9001)
- Storage devices for Ceph (direct disk on node0, USB disks on node1/node2)
- SemaphoreUI instance for running deployments

### Repository Structure

```
autok8s/
├── terraform/
│   ├── main.tf            # VM configuration
│   ├── variables.tf       # Input variables
│   ├── outputs.tf         # Output definitions
│   └── providers.tf       # Provider configuration
└── ansible/
    ├── inventory/
    │   └── hosts.ini      # Generated by Terraform
    ├── playbooks/
    │   ├── site.yml       # Main playbook
    │   ├── microk8s.yml   # MicroK8s-specific playbook
    │   └── microceph.yml  # MicroCeph-specific playbook
    └── roles/
        ├── common/        # Base configuration
        ├── disk_passthrough/ # Storage device setup
        ├── microk8s/      # Kubernetes setup
        └── microceph/     # Ceph storage setup
```
## Deployment Process
The deployment follows these steps:

1. VM Provisioning: Create three virtual machines on separate Proxmox nodes
2. Common Setup: Configure basic system settings on all nodes
3. Disk Passthrough: Configure storage device passthrough to VMs
4. MicroK8s Setup: Install and configure the Kubernetes cluster
5. MicroCeph Setup: Set up distributed storage and integrate with Kubernetes
## Usage with SemaphoreUI
1. Import the repository into SemaphoreUI
2. Create task templates for each deployment phase:
    - Deploy VMs (Terraform)
    - Common Setup
    - Disk Passthrough
    - MicroK8s Setup
    - MicroCeph Setup
3. Configure environment variables for Proxmox authentication
Run tasks sequentially or create a workflow
## Manual Deployment (Alternative)
### Terraform Deployment
```
cd terraform
terraform init
terraform apply
```
### Ansible Deployment
```
cd ansible
ansible-playbook -i inventory/hosts.ini playbooks/site.yml
```
Customization
Edit `terraform/variables.tf` to adjust VM specifications
Modify `ansible/roles/*/defaults/main.yml` files to customize configurations
Update disk IDs in `ansible/roles/disk_passthrough/defaults/main.yml`
## Troubleshooting
- Check Terraform logs for VM provisioning issues
- Verify Proxmox API access and permissions
- Examine Ansible logs for configuration details
- Consult MicroK8s documentation for Kubernetes-specific issues
## License
MIT

## Acknowledgments
 - MicroK8s Documentation
 - MicroCeph Documentation
 - OpenTofu Documentation
 - Proxmox VE API Documentation